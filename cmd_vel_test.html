<!DOCTYPE html>

<!-- Change the size of the AR object according to cmd_vel -->
<!-- Works if this is executed on the device running roscore -->
<!-- When this html file is opened on other device, -->
<!-- AR only works on https (does not work on http) -->
<!-- ROS WebSocket connection does not work on https due to CORS (works on http) -->
<!-- Need to solve CORS problem to have both AR and ROS work at the same time -->

<html>
  <head>
    <title>AR Demo</title>
    <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/Ar.js/1.6.2/aframe/build/aframe-ar.js"></script>
    <script src="src/roslib.js"></script>
  </head>

  <body style="margin: 0px; overflow: hidden;">
    <a-scene embedded arjs>
      <a-marker preset="hiro">
        <a-octahedron position="0 0.5 0" radius="0.75" material="color: #87CEEB; opacity: 0.7;" size-updater></a-octahedron>
      </a-marker>
      <a-entity camera></a-entity>

      <script>
        var my_ip = "192.168.0.45"
        var ros = new ROSLIB.Ros();

        ros.on('error', function(error) {
          console.log('Error connecting to ROS: ', error);
        });

        ros.on('connection', function() {
          console.log('Connected to ROS');
        });

        ros.on('close', function() {
          console.log('Connection to ROS closed');
        });
        
        ros.connect('ws://' + my_ip + ':9090');

        var marker = document.querySelector("a-marker");
        var box = marker.querySelector("a-octahedron");

        var listener = new ROSLIB.Topic({
          ros : ros,
          name : '/cmd_vel',
          messageType : 'geometry_msgs/Twist'
        });

        var newSize = 0.1;

        function updateSize() {
          box.setAttribute("scale", `${newSize} ${newSize} ${newSize}`);
          console.log('Updated size to ' + newSize);
        }

        listener.subscribe(function(message) {
          newSize = 0.1 + 3 * Math.abs(message.linear.x);
          console.log('Received message on ' + listener.name + ': ' + message.linear.x);
          updateSize();
        });
      </script>
    </a-scene>
  </body>
</html>
