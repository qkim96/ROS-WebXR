<!DOCTYPE html>

<!-- Display laser scan with /scan -->

<html>
  <head>
    <title>Lidar Display Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/Ar.js/1.6.2/aframe/build/aframe-ar.js"></script>
    <script src="src/roslib.js"></script>
    <style>
      body {
          margin: 0px;
          overflow: hidden;
          display: flex;
          justify-content: center;
          align-items: flex-end;
          height: 100vh;
      }
  </style>
  </head>

  <body>
    <a-scene embedded arjs="debugUIEnabled: false;">
      <a-marker preset="hiro"></a-marker>
      <a-entity camera></a-entity>

      <script>
        var my_ip = "192.168.0.45"  // check IP address with "hostname -I"
        var ros = new ROSLIB.Ros();

        ros.on('error', function(error) {
          console.log('Error connecting to ROS: ', error);
        });

        ros.on('connection', function() {
          console.log('Connected to ROS');
        });

        ros.on('close', function() {
          console.log('Connection to ROS closed');
        });
        
        ros.connect('wss://' + my_ip + ':9090');

        var lidarScan = new ROSLIB.Topic({
          ros : ros,
          name : '/scan',
          messageType : 'sensor_msgs/LaserScan'
        });

        lidarScan.subscribe(function(message) {
          const unitScale = 1.0
          const distThreshold = 1.0
          const scene = document.querySelector("a-marker");
          const existingSpheres = scene.querySelectorAll("a-sphere");

          existingSpheres.forEach((sphere) => {
            scene.removeChild(sphere);
          });

          distances = message.ranges

          for (let i = 0; i < 360; i++) {
            d = distances[i]
            degrees = (i + 90) % 360
            radians = (degrees * Math.PI) / 180;

            if ((degrees > 180 && degrees < 360 ) || (d * unitScale > distThreshold) || (d == null)) {
            // if ((d * unitScale > distThreshold) || (d == null)) {
              continue;
            }
            
            let x = unitScale * d * Math.cos(radians)
            let y = -1 * unitScale * d * Math.sin(radians)
            let position = `${x} ${y} 0`;
            let entity = document.createElement("a-sphere");
            entity.setAttribute("color", "red");
            entity.setAttribute("radius", "0.02");
            entity.setAttribute("position", position);
            document.querySelector("a-marker").appendChild(entity);
          }
        });
      </script>
    </a-scene>
  </body>
</html>
